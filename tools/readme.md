# How to run A01 with a awagger-to-sdk autogenerated branch

Note: this instructions were created with user credentials in mind, not service principal credentials. To create runs with SP creds, some commads need extra flags. Also, this insctructions are specific to Azure SDK for Go. This documentation assumes your mashine has `go`, `dep`, `bash`, `docker` and `az` tools installed.

For documentation / experimentation purposes, I have already created a PR to the swaggers repo containing breaking changes (I changed some properties types in the compute swagger) that would make the samples / tests fail:
https://github.com/Azure/azure-rest-api-specs/pull/2605
This PR, has autogenerated the go SDK and created a PR to the go SDK repo, which can be found here:
https://github.com/Azure/azure-sdk-for-go/pull/1205

## Prepare the docker image

First, let's prepare the docker image with the required autogenerated SDK. This docker image will be used by A01 to test the samples. Go get the samples repo.

``` bash
go get github.com/Azure-Samples/azure-sdk-for-go-samples
cd $GOPATH/github.com/Azure-Samples/azure-sdk-for-go-samples
```

If present, delete the `vendor` folder, and the `Gopkg.lock` file.
Modify the `Gopkg.toml` file so it points to the correct SDK branch. In this PR's case in particular, the SDK constraint instead of looking like this:

``` toml
[[constraint]]
  name = "github.com/Azure/azure-sdk-for-go"
  branch = "master"
```

should look like this:

``` toml
[[constraint]]
  name = "github.com/Azure/azure-sdk-for-go"
  branch = "restapi_auto_2605"
```

Now, run `dep ensure` to get the dependecies, including this defective SDK. If you run the create VM sample locally, it should fail.

``` bash
go test ./compute/... -timeout 20m -run ^ExampleCreateVM$ -v
```

## Push the image to the registry

Ready to build and push the docker image. You will need at least contributor permissions to the `azureclidev` container registry in the `Azure SDK infrastructure` subscription. Login to the registry:

``` bash
az acr login -n azureclidev
```

The samples repo already contains a bash script that will build and push the docker image:

``` bash
bash tools/build_container.sh
```

It is a good idea to verify the image has been pushed to the registry. Take note of the registry, repository and tag the image has, as it is a required parameter for starting an A01 run. It should look very similar to this:

```
azureclidev.azurecr.io/azuresdk-test-private-mariana:go1.10-201803261319
```

## Start an A01 run

To create runs, you will need contributor access to the `adx-automation` managed container service in the `Azure SDK infrastructure` subscription, and the a01 client.

Instuctions to install the a01 client here:
https://github.com/Azure/adx-automation-client

A01 also requires some extra login info:

``` bash
az login
az account set -s <Azure SDK infrastructure subscription ID>
az aks get-credentials -g adx-automation-a01 -n adx-automation
a01 login --endpoint secondapi.azclitest.com
```

Create a test run. If you want to receive an email on run completion, add the `--email` option. The tests, by default, run on `westus2` Azure location (unless a service is not available in that location. In that case, the tests themselves will override the deafult location to an available one). Default location can be set with the `--mode` flag: if you want the tests to run in Canary, add `--mode centraluseuap`.

``` bash
a01 create run azureclidev.azurecr.io/azuresdk-test-private-mariana:go1.10-201803261319 --email --mode centraluseuap
```

Voila! Test run has been created with a swagger-to-sdk branch.
